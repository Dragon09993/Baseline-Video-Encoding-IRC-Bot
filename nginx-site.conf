server {
    listen 8084 default_server;
    listen [::]:8084 default_server;
    
    server_name _ localhost 10.0.0.2;
    root /app/output;
    index index.html;
    
    # CORS headers for video access from any device on network
    add_header Access-Control-Allow-Origin "*" always;
    add_header Access-Control-Allow-Methods "GET, HEAD, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Range, Content-Type" always;
    add_header Access-Control-Expose-Headers "Accept-Ranges, Content-Encoding, Content-Length, Content-Range" always;
    
    # Video streaming optimizations
    location ~* \.(mp4|webm|ogg|avi|mov|flv|wmv|m4v|3gp|mkv)$ {
        # Essential for video seeking - enable range requests
        add_header Accept-Ranges bytes always;
        
        # Cache videos for 1 week (they don't change)
        expires 7d;
        add_header Cache-Control "public, no-transform, immutable";
        
        # Optimize file serving for large video files
        sendfile on;
        sendfile_max_chunk 2m;
        tcp_nopush on;
        tcp_nodelay on;
        
        # Prevent buffering for streaming
        proxy_buffering off;
        
        # Set proper MIME type
        add_header Content-Type "video/mp4" always;
        
        # Security headers
        add_header X-Content-Type-Options "nosniff" always;
    }
    
    # Handle CORS preflight requests for video files
    location ~ \.(mp4|webm|ogg|avi|mov|flv|wmv|m4v|3gp|mkv)$ {
        if ($request_method = OPTIONS) {
            add_header Access-Control-Allow-Origin "*";
            add_header Access-Control-Allow-Methods "GET, HEAD, OPTIONS";
            add_header Access-Control-Allow-Headers "Range, Content-Type";
            add_header Access-Control-Max-Age 86400;
            add_header Content-Length 0;
            add_header Content-Type "text/plain";
            return 204;
        }
    }
    
    # Directory listing with custom styling
    location / {
        # Try to serve file, then directory, then custom index
        try_files $uri $uri/ @autoindex;
        
        # Serve custom HTML interface if available
        location = / {
            try_files /index.html @autoindex;
        }
    }
    
    # Custom autoindex fallback
    location @autoindex {
        autoindex on;
        autoindex_exact_size off;
        autoindex_localtime on;
        autoindex_format html;
    }
    
    # Serve custom web interface
    location = /index.html {
        root /app/www;
        expires 1h;
        add_header Cache-Control "public, must-revalidate";
    }
    
    # Static assets for web interface
    location ~ \.(css|js|ico|png|jpg|jpeg|gif|svg)$ {
        root /app/www;
        expires 1d;
        add_header Cache-Control "public";
    }
    
    # Security settings
    server_tokens off;
    
    # Hide sensitive files
    location ~ /\.(ht|env|git) {
        deny all;
        return 404;
    }
    
    # Error handling
    error_page 404 /404.html;
    error_page 500 502 503 504 /50x.html;
    
    # Client settings for large video files
    client_max_body_size 10G;
    client_body_timeout 300s;
    client_header_timeout 300s;
}