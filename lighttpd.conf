server.modules = (
    "mod_access",
    "mod_alias",
    "mod_compress",
    "mod_redirect",
    "mod_setenv",
    "mod_dirlisting"
)

server.document-root        = "/app/output"
server.upload-dirs          = ( "/var/cache/lighttpd/uploads" )
server.errorlog             = "/var/log/lighthttpd/error.log"
server.pid-file             = "/var/run/lighthttpd.pid"
server.username             = "www-data"
server.groupname            = "www-data"
server.port                 = 8084
server.bind                 = "0.0.0.0"

# Enable directory listings with custom styling
dir-listing.activate        = "enable"
dir-listing.hide-dotfiles   = "enable"
dir-listing.exclude         = ( "~$" )
dir-listing.show-readme     = "enable"
dir-listing.show-header     = "enable"
dir-listing.encoding        = "utf-8"

# Set proper MIME types for video files
mimetype.assign = (
  ".mp4"          =>      "video/mp4",
  ".mkv"          =>      "video/x-matroska",
  ".avi"          =>      "video/x-msvideo",
  ".mov"          =>      "video/quicktime",
  ".webm"         =>      "video/webm",
  ".m4v"          =>      "video/mp4",
  ".flv"          =>      "video/x-flv",
  ".wmv"          =>      "video/x-ms-wmv",
  ".html"         =>      "text/html",
  ".htm"          =>      "text/html",
  ".css"          =>      "text/css",
  ".js"           =>      "text/javascript",
  ".txt"          =>      "text/plain",
  ".log"          =>      "text/plain"
)

# Enable compression for text files
compress.cache-dir          = "/var/cache/lighthttpd/compress/"
compress.filetype           = ( "application/javascript", "text/css", "text/html", "text/plain" )

# Security headers for video files
$HTTP["url"] =~ "\.(mp4|mkv|avi|mov|webm|m4v)$" {
    setenv.add-response-header = (
        "Accept-Ranges" => "bytes",
        "Cache-Control" => "public, max-age=31536000",
        "Access-Control-Allow-Origin" => "*",
        "Access-Control-Allow-Methods" => "GET, HEAD, OPTIONS",
        "Access-Control-Allow-Headers" => "Range, Content-Range"
    )
}

# Enable range requests for video streaming
server.range-requests = "enable"

# Index files
index-file.names            = ( "index.php", "index.html", "index.lighttpd.html" )

# URL handling
url.access-deny             = ( "~", ".inc" )

# Static file handling optimizations
server.max-keep-alive-requests = 4
server.max-keep-alive-idle = 4
server.max-read-idle = 60
server.max-write-idle = 360

# File upload size limits
server.max-request-size = 0  # No limit for large video uploads

# Connection limits
server.max-connections = 1024